name: "Setup Playwright"
description: "Install Playwright browsers and dependencies with caching"
inputs:
  browsers:
    description: "Space-separated list of browsers to install (e.g., 'chromium', 'chromium webkit')"
    required: false
    default: "chromium"
  package-manager:
    description: "Package manager to use (pnpm, npm, yarn, bun, deno)"
    required: false
    default: "pnpm"
runs:
  using: "composite"
  steps:
    - name: Get Playwright version
      id: playwright-version
      shell: bash
      run: |
        # Extract Playwright version based on package manager; skip gracefully if not installed
        VERSION=""
        case "${{ inputs.package-manager }}" in
          pnpm)
            VERSION=$(pnpm exec playwright --version 2>/dev/null | grep -oE '[0-9]+(\.[0-9]+)+') || true
            ;;
          npm)
            VERSION=$(npm exec playwright -- --version 2>/dev/null | grep -oE '[0-9]+(\.[0-9]+)+') || true
            ;;
          yarn)
            VERSION=$(yarn exec playwright --version 2>/dev/null | grep -oE '[0-9]+(\.[0-9]+)+') || true
            ;;
          bun)
            VERSION=$(bun run playwright --version 2>/dev/null | grep -oE '[0-9]+(\.[0-9]+)+') || true
            ;;
          deno)
            VERSION=$(deno run playwright --version 2>/dev/null | grep -oE '[0-9]+(\.[0-9]+)+') || true
            ;;
          *)
            echo "Unsupported package manager: ${{ inputs.package-manager }}"
            exit 1
            ;;
        esac
        if [ -n "$VERSION" ]; then
          echo "available=true" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Playwright version: $VERSION"
        else
          echo "available=false" >> $GITHUB_OUTPUT
          echo "version=" >> $GITHUB_OUTPUT
          echo "Playwright not found in project, skipping setup"
        fi

    - name: Set Playwright cache path
      id: playwright-cache-path
      if: steps.playwright-version.outputs.available == 'true'
      shell: bash
      run: |
        if [ "${{ runner.os }}" == "Windows" ]; then
          CACHE_PATH="$LOCALAPPDATA/ms-playwright"
        else
          CACHE_PATH="$HOME/.cache/ms-playwright"
        fi
        echo "path=$CACHE_PATH" >> $GITHUB_OUTPUT
        echo "Playwright cache path: $CACHE_PATH"

    - name: Cache Playwright browsers
      id: cache-playwright
      if: steps.playwright-version.outputs.available == 'true'
      uses: actions/cache@v5
      with:
        path: ${{ steps.playwright-cache-path.outputs.path }}
        key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-${{ inputs.browsers }}
        restore-keys: |
          ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-

    - name: Install Playwright browsers
      if: steps.playwright-version.outputs.available == 'true' && steps.cache-playwright.outputs.cache-hit != 'true'
      shell: bash
      run: |
        case "${{ inputs.package-manager }}" in
          pnpm)
            pnpm exec playwright install --with-deps ${{ inputs.browsers }}
            ;;
          npm)
            npm exec playwright install --with-deps ${{ inputs.browsers }}
            ;;
          yarn)
            yarn exec playwright install --with-deps ${{ inputs.browsers }}
            ;;
          bun)
            bun run playwright install --with-deps ${{ inputs.browsers }}
            ;;
          deno)
            deno run playwright install --with-deps ${{ inputs.browsers }}
            ;;
          *)
            echo "Unsupported package manager: ${{ inputs.package-manager }}"
            exit 1
            ;;
        esac